name: Zulip Production Suite

on:
  push:
  pull_request:

defaults:
  run:
    shell: bash

jobs:
  production_build:
    name: Bionic Production Build
    runs-on: ubuntu-latest

    # This docker image was created by a generated Dockerfile at:
    #   tools/ci/images/bionic/Dockerfile
    # Bionic ships with Python 3.6.
    container: mepriyank/actions:bionic
    steps:
      - name: Add required permissions
        run: |
          # The checkout actions doesn't clone to ~/zulip or allow
          # us to use the path option to clone outside the current
          # /__w/zulip/zulip directory. Since this directory is owned
          # by root we need to change it's ownership to allow the
          # github user to clone the code here.
          # Note: /__w/ is a docker volume mounted to $GITHUB_WORKSPACE
          # which is /home/runner/work/.
          sudo chown -R github .

          # This is the GitHub Actions specific cache directory the
          # the current github user must be able to access for the
          # cache action to work. It is owned by root currently.
          sudo chmod -R 0777 /__w/_temp/

      - uses: actions/checkout@v2

      - name: Create cache directories
        run: |
          dirs=(/srv/zulip-{npm,venv,emoji}-cache)
          sudo mkdir -p "${dirs[@]}"
          sudo chown -R github "${dirs[@]}"

      - name: Restore node_modules cache
        uses: actions/cache@v2
        with:
          path: /srv/zulip-npm-cache
          key: v1-yarn-deps-${{ matrix.os }}-${{ hashFiles('package.json') }}-${{ hashFiles('yarn.lock') }}
          restore-keys: v1-yarn-deps-${{ matrix.os }}

      - name: Restore python cache
        uses: actions/cache@v2
        with:
          path: /srv/zulip-venv-cache
          key: v1-venv-${{ matrix.os }}-${{ hashFiles('requirements/thumbor-dev.txt') }}-${{ hashFiles('requirements/dev.txt') }}
          restore-keys: v1-venv-${{ matrix.os }}

      - name: Restore emoji cache
        uses: actions/cache@v2
        with:
          path: /srv/zulip-emoji-cache
          key: v1-emoji-${{ matrix.os }}-${{ hashFiles('tools/setup/emoji/emoji_map.json') }}-${{ hashFiles('tools/setup/emoji/build_emoji') }}-${{ hashFiles('tools/setup/emoji/emoji_setup_utils.py') }}-${{ hashFiles('tools/setup/emoji/emoji_names.py') }}-${{ hashFiles('package.json') }}
          restore-keys: v1-emoji-${{ matrix.os }}

      - name: Do Bionic hack
        run: |
          # Temporary hack till `sudo service redis-server start` gets fixes in Bionic. See
          # https://chat.zulip.org/#narrow/stream/3-backend/topic/Ubuntu.20bionic.20CircleCI
          sudo sed -i '/^bind/s/bind.*/bind 0.0.0.0/' /etc/redis/redis.conf

      - name: Build production tarball
        run: mispipe "./tools/ci/production-build 2>&1" ts

      - name: Prepare production tarball directory
        run: |
          files=(
            /tmp/zulip-server-test.tar.gz
            /tmp/success-http-headers.template.txt
            /tmp/production-install
            /tmp/production-verify
            /tmp/production
            /tmp/production-extract-tarball
            /tmp/production-upgrade-pg
          )

          mkdir ./var/production-tarball
          mv "${files[@]}" ./var/production-tarball || true
          ls ./var/production-tarball

      - name: Upload production tarball for use in install jobs
        uses: actions/upload-artifact@v2
        with:
          name: production-tarball
          path: ./var/production-tarball

  production_install:
    strategy:
      fail-fast: false
      matrix:
        include:
          - docker_image: mepriyank/actions:bionic
            name: Bionic Production Install
            is_bionic: true
            os: bionic

          - docker_image: mepriyank/actions:focal
            name: Focal Production Install
            is_focal: true
            os: focal

    name: ${{ matrix.name  }}
    container: ${{ matrix.docker_image }}
    runs-on: ubuntu-latest
    needs: production_build
    env:
      # GitHub Actions overrides HOME to /github/home/ in docker
      # initialization step which have no control over.
      HOME: /home/zulip

    steps:
      - name: Download built production tarball
        uses: actions/download-artifact@v2
        with:
          name: production-tarball
          path: /tmp

      - name: Add required permissions
        # This is the GitHub Actions specific cache directory the
        # the current github user must be able to access for the
        # cache action to work. It is owned by root currently.
        run: sudo chmod -R 0777 /__w/_temp/ && mkdir /home/github/zulip

      - name: Create cache directories
        run: |
          dirs=(/srv/zulip-{npm,venv,emoji}-cache)
          sudo mkdir -p "${dirs[@]}"
          sudo chown -R github "${dirs[@]}"

      - name: Restore node_modules cache
        uses: actions/cache@v2
        with:
          path: /srv/zulip-npm-cache
          key: v1-yarn-deps-${{ matrix.os }}-${{ hashFiles('package.json') }}-${{ hashFiles('yarn.lock') }}
          restore-keys: v1-yarn-deps-${{ matrix.os }}

      - name: Do Bionic hack
        if: ${{ matrix.is_bionic }}
        run: |
          # Temporary hack till `sudo service redis-server start` gets fixes in Bionic. See
          # https://chat.zulip.org/#narrow/stream/3-backend/topic/Ubuntu.20bionic.20CircleCI
          sudo sed -i '/^bind/s/bind.*/bind 0.0.0.0/' /etc/redis/redis.conf

      - name: Do memcached hack
        if: ${{ matrix.is_focal }}
        run: |
          # Temporary hack till memcached upstream is updated in Focal.
          # https://bugs.launchpad.net/ubuntu/+source/memcached/+bug/1878721
          echo "export SASL_CONF_PATH=/etc/sasl2" | sudo tee - a /etc/default/memcached

      - name: Production extract tarball
        run: |
          # Since download-artifact unzips the artifact uploaded
          # in build production job in such a way it loses permissions
          chmod +x /tmp/production-extract-tarball
          mispipe "/tmp/production-extract-tarball 2>&1" ts

      - name: Install production
        run: |
          chmod +x /tmp/production-install
          sudo service rabbitmq-server restart
          sudo mispipe "/tmp/production-install 2>&1" ts

      - name: Verify install
        run: |
          chmod +x /tmp/production-verify
          sudo mispipe "/tmp/production-verify 2>&1" ts

      - name: Upgrade postgresql
        if: ${{ matrix.is_bionic }}
        run: |
          chmod +x /tmp/production-upgrade-pg
          sudo mispipe "/tmp/production-upgrade-pg 2>&1" ts

      - name: Verify install after upgrading postgresql
        run: sudo mispipe "/tmp/production-verify 2>&1" ts
